# Stage template: RG Tags
parameters:
  run_mode: 'ByCustodian'          # ByCustodian | AllADH
  adh_group: ''
  adh_subscription_type: ''        # prd | nonprd
  variableGroup: 'modernization_tfstate_backend_details'
  outDir: '$(Build.ArtifactStagingDirectory)/rg-tags'
  branchName: ''
  poolType: 'hosted'               # hosted | self
  poolPrefix: ''                   # optional
  poolSuffix: ''                   # e.g., '_agent1' | '_agent2'
  poolName: ''                     # explicit override when poolType=self

# ---------- ByCustodian ----------
- ${{ if eq(parameters.run_mode, 'ByCustodian') }}:
  - stage: RG_Tags_ByCustodian
    displayName: "RG Tags (ByCustodian: ${{ parameters.adh_group }})"

    variables:
      outDir: ${{ parameters.outDir }}

    jobs:
    - template: ../templates/job.powershell-with-az.yml
      parameters:
        variableGroup: ${{ parameters.variableGroup }}
        displayName: 'RG Tags Scan (ByCustodian)'
        scriptPath: 'sanitychecks/scripts/Scan-RG-Tags.ps1'
        workingDir: '$(Build.SourcesDirectory)/sanitychecks/scripts'
        arguments: >
          -TenantId "$(tenant_id)"
          -ClientId "$(backend_client_id)"
          -ClientSecret "$(backend_client_secret)"
          -adh_group "${{ parameters.adh_group }}"
          -OutputDir "$(outDir)"
          -BranchName "${{ parameters.branchName }}"
        artifactName: "rg-tags"
        publishPath: "$(outDir)"

        poolType: ${{ parameters.poolType }}
        ${{ if and(ne(parameters.poolType, 'hosted'), ne(parameters.poolName, '')) }}:
          poolName: ${{ parameters.poolName }}
        ${{ if and(ne(parameters.poolType, 'hosted'), eq(parameters.poolName, '')) }}:
          poolName: ${{ parameters.poolPrefix }}${{ parameters.adh_group }}_${{ parameters.adh_subscription_type }}${{ parameters.poolSuffix }}

        adh_group: ${{ parameters.adh_group }}
        adh_subscription_type: ${{ parameters.adh_subscription_type }}

# ---------- AllADH ----------
- ${{ if ne(parameters.run_mode, 'ByCustodian') }}:
  - stage: RG_Tags_AllADH
    displayName: "RG Tags (All ADH)"

    variables:
      outDir: ${{ parameters.outDir }}

    jobs:
    - template: ../templates/job.powershell-with-az.yml
      parameters:
        variableGroup: ${{ parameters.variableGroup }}
        displayName: 'RG Tags Scan (AllADH)'
        scriptPath: 'sanitychecks/scripts/Scan-RG-Tags.ps1'
        workingDir: '$(Build.SourcesDirectory)/sanitychecks/scripts'
        arguments: >
          -TenantId "$(tenant_id)"
          -ClientId "$(backend_client_id)"
          -ClientSecret "$(backend_client_secret)"
          -ScanAll
          -OutputDir "$(outDir)"
          -BranchName "${{ parameters.branchName }}"
        artifactName: "rg-tags-ALLADH"
        publishPath: "$(outDir)"

        poolType: ${{ parameters.poolType }}
        ${{ if ne(parameters.poolType, 'hosted') }}:
          poolName: ${{ parameters.poolName }}

        adh_group: ''
        adh_subscription_type: ${{ parameters.adh_subscription_type }}
