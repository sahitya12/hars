parameters:
  adh_subscription_type: ''
  secretsCsvPath: ''
  variableGroup: 'modernization_tfstate_backend_details'
  outDir: '$(Build.ArtifactStagingDirectory)/kv-secrets'
  branchName: ''
  poolType: 'self'
  poolName: ''
  poolSuffix: '_agent1'
  useDemands: false

stages:
- stage: KV_Secrets_AllADH
  displayName: "KV Secrets â€“ ALLADH"
  variables:
    outDir: ${{ parameters.outDir }}
  jobs:
  - template: ../templates/job.powershell-with-az.yml
    parameters:
      variableGroup: ${{ parameters.variableGroup }}
      displayName: 'KV Secrets Scan (AllADH)'
      scriptPath: 'sanitychecks/scripts/Scan-KV-Secrets-AllADH.ps1'
      workingDir: '$(Build.SourcesDirectory)/sanitychecks/scripts'
      arguments: >
        -TenantId "$(tenant_id)" -ClientId "$(backend_client_id)" -ClientSecret "$(backend_client_secret)"
        -SecretCsvPath "${{ parameters.secretsCsvPath }}"
        -OutputDir "$(outDir)" -BranchName "${{ parameters.branchName }}"
      artifactName: 'kv-secrets-ALLADH'
      publishPath: '$(outDir)'
      poolType: ${{ parameters.poolType }}
      poolName: ${{ parameters.poolName }}
      poolSuffix: ${{ parameters.poolSuffix }}
      adh_group: ''
      adh_subscription_type: ${{ parameters.adh_subscription_type }}
      useDemands: ${{ parameters.useDemands }}
